# GitHub Copilot Custom Instructions for DTS App

## GraphQL Integration Guidelines

### **ALWAYS Reference GraphQL Documentation First**

When working with any GraphQL-related code in this project, you MUST reference the following documentation files before making suggestions or modifications:

1. **Primary Schema Reference**: `DTS App/DTS App/Docs/GraphQL/jobber_schema.graphql.txt`
   - Contains the complete Jobber GraphQL schema (60,218+ lines)
   - Use this to verify field names, types, and relationships
   - Check this file for available queries, mutations, and type definitions

2. **API Reference Guide**: `DTS App/DTS App/Docs/GraphQL/JOBBER_API_REFERENCE.md`
   - Structured reference document with organized sections
   - Contains field mappings and usage patterns
   - Includes best practices for Jobber API integration

3. **Comprehensive Technical Guide**: `DTS App/DTS App/Docs/GraphQL/The Jobber GraphQL API_ A Comprehensive Technical Analysis and Developer's Guide (1).pdf`
   - Detailed technical analysis and implementation patterns
   - Advanced GraphQL concepts and optimization strategies

### **GraphQL-Specific Rules**

#### Field Validation
- **ALWAYS** verify field names against `jobber_schema.graphql.txt` before suggesting GraphQL queries
- Check that requested fields actually exist in the schema
- Validate nested field paths and relationships
- Ensure proper type casting for ID fields (Base64-encoded vs numeric)

#### ID Handling
- Jobber GraphQL returns Base64-encoded IDs (e.g., `Z2lkOi8vSm9iYmVyL0NsaWVudC84MDA0NDUzOA==`)
- These decode to `gid://Jobber/Type/NumericId` format
- Web URLs require numeric IDs only (e.g., `80044538`)
- Always use the `extractNumericId()` function from `DataModels.swift` for web URL construction

#### Query Structure
- Reference existing queries in `JobberAPI.swift` as templates
- Follow established patterns for pagination, filtering, and field selection
- Use the schema to understand available arguments and their types
- Respect GraphQL query complexity and depth limits

#### Error Handling
- Account for GraphQL-specific error responses
- Handle both network errors and GraphQL field errors
- Validate responses against expected schema types
- Implement proper null checking for optional fields

### **Implementation Workflow**

1. **Schema Check**: Before writing any GraphQL code, search the schema file for relevant types and fields
2. **Pattern Matching**: Look at existing implementations in `JobberAPI.swift` for similar functionality
3. **Validation**: Cross-reference field paths and types with the schema
4. **Testing**: Ensure any new GraphQL operations include proper error handling

### **File-Specific Guidelines**

#### `JobberAPI.swift`
- All GraphQL queries must be validated against the schema
- Follow existing naming conventions for query variables
- Include proper error handling for all GraphQL operations
- Add debug logging for ID transformations and URL construction

#### `DataModels.swift`
- JobberJob model must reflect actual GraphQL response structure
- Use computed properties for derived fields (like web URLs)
- Include proper ID extraction methods for Base64-encoded fields
- Add validation for required vs optional fields based on schema

#### URL Construction
- Always extract numeric IDs from Base64-encoded GraphQL IDs
- Prioritize client URLs (`https://secure.getjobber.com/clients/{id}`) for web access
- Include debug logging to trace ID transformation process
- Validate URLs against known working patterns

### **Code Review Checklist**

Before suggesting any GraphQL-related changes:
- [ ] Verified all field names exist in `jobber_schema.graphql.txt`
- [ ] Checked field types match schema definitions
- [ ] Validated nested field paths are correct
- [ ] Ensured proper ID handling (Base64 â†’ numeric conversion)
- [ ] Referenced existing patterns in `JobberAPI.swift`
- [ ] Included appropriate error handling
- [ ] Added debug logging for troubleshooting

### **Common Patterns to Follow**

#### Query Template
```graphql
query GetScheduledItems($first: Int!, $after: String) {
  scheduledItems(first: $first, after: $after) {
    edges {
      node {
        # Always verify these fields exist in schema
        id
        client {
          id
          name
          # Check nested fields in schema
        }
        request {
          id
          # Validate request fields
        }
      }
    }
    pageInfo {
      hasNextPage
      endCursor
    }
  }
}
```

#### ID Extraction Pattern
```swift
// Always use extractNumericId for web URLs
private func extractNumericId(from base64Id: String) -> String? {
    // Reference implementation in DataModels.swift
    guard let data = Data(base64Encoded: base64Id),
          let decoded = String(data: data, encoding: .utf8) else {
        return nil
    }
    // Extract numeric portion from gid://Jobber/Type/123456
    // Return numeric ID for web URL construction
}
```

### **Documentation Updates**

When adding new GraphQL functionality:
1. Document any new field mappings discovered
2. Update code comments with schema references
3. Include examples of successful query patterns
4. Note any API limitations or special handling requirements

---

**Remember**: The GraphQL schema is the source of truth. Always validate against it before implementing GraphQL-related functionality.
